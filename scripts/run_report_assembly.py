import json
import os
import datetime

# --- Configuration ---
JSON_PATH = "mining_results.json"
OUTPUT_REPORT = "2025_MemoryLane_Final.md"

def load_results():
    with open(JSON_PATH, 'r', encoding='utf-8') as f:
        return json.load(f)

def generate_markdown():
    data = load_results()
    
    # Extract Data Shortcuts
    origin = data['origin']
    weight = data['weight']
    summary = data['summary']
    heatmap = data['heatmap']
    rhythm = data['rhythm']
    content = data['content']
    radar = data['radar']
    interaction = data['interaction']
    
    # Calculate derived metrics for text
    scroll_km = summary['total_text_chars_2025'] * 0.05 / 100000 # Assume 5cm per char scroll? Maybe msg count * 5cm
    scroll_km = summary['total_2025'] * 5 / 100000 # 5cm per msg -> km
    
    peak_hour = max(rhythm['hourly_dist'], key=rhythm['hourly_dist'].get)
    
    # Initiator Ratio
    init_dxa = interaction['initiator_counts']['dxa']
    init_lxg = interaction['initiator_counts']['lxg']
    total_init = init_dxa + init_lxg
    if total_init > 0:
        ratio_lxg = int((init_lxg / total_init) * 100)
        ratio_dxa = int((init_dxa / total_init) * 100)
    else:
        ratio_lxg = 0
        ratio_dxa = 0
        
    initiator_winner = "lxg" if init_lxg > init_dxa else "dxa"
    initiator_ratio = ratio_lxg if initiator_winner == "lxg" else ratio_dxa
    
    # Markdown Content Construction
    md = f"""# ğŸ® MemoryLane: 2025 å¹´åº¦æƒ…æ„Ÿæ¡£æ¡ˆ
> â€œæ¯ä¸€å¥åºŸè¯ï¼Œéƒ½æ˜¯æˆ‘ä»¬ç›¸çˆ±çš„è¯æ®ã€‚â€

---

## ğŸ•°ï¸ Chapter 1: The Origin (ç¼˜èµ·)

> æˆ‘ä»¬ç¬¬ä¸€æ¬¡èŠå¤©åœ¨ **{origin['first_contact_date'][:10]}**ã€‚
> è·ä»Šå·²æœ‰ **{origin['total_days']}** å¤©ã€‚
> 2025å¹´çš„ç¬¬ä¸€æ®µå¯¹è¯ï¼Œæ˜¯ç”± **{origin['year_start_sender']}** å‘èµ·çš„ï¼š
> *â€œ{origin['year_start_content']}â€*

---

## ğŸ§Š Chapter 2: The Icebreaker (ç ´å†°)

> 2025å¹´ï¼Œä½ ä»¬çš„æ‰‹æŒ‡åœ¨å±å¹•ä¸Šè¡Œèµ°äº† **{scroll_km:.2f}** å…¬é‡Œã€‚è¿™ä¸€å¹´ï¼ŒåŸæ¥æˆ‘ä»¬æœ‰è¿™ä¹ˆå¤šè¯è¦è®²ã€‚

*   **å¹´åº¦æ€»æ¶ˆæ¯**: {summary['total_2025']} æ¡
*   **å¹´åº¦æ€»çƒ­åº¦**: {heatmap['active_days']} / 365 å¤©åœ¨çº¿
*   **å·…å³°æ—¶åˆ»**: {heatmap['peak_day']} (å•æ—¥å‘é€ {heatmap['peak_count']} æ¡)

![Calendar Heatmap](assets/viz_calendar.png)

---

## ğŸŒ™ Chapter 3: Time & Rhythm (åŒé¢‘)

> **{peak_hour}:00** æ˜¯ä½ ä»¬çš„â€˜æ³•å®šèŠå¤©æ—¶é—´â€™ã€‚
> è¿™ä¸€å¹´ï¼Œ**dxa** åšäº† **{rhythm['night_watchman'].get('dxa', 0)}** æ¬¡å®ˆå¤œäººï¼Œ**lxg** åšäº† **{rhythm['night_watchman'].get('lxg', 0)}** æ¬¡å®ˆå¤œäººï¼Œåªä¸ºè®©ä½ å®‰å¿ƒå…¥ç¡ï¼ˆæˆ–è€…ä»…ä»…æ˜¯å› ä¸ºç¡ä¸ç€ï¼‰ã€‚

![Rose Clock](assets/viz_rose_clock.png)

*   **ç†¬å¤œæŒ‡æ•°**: å‡Œæ™¨1ç‚¹åˆ°5ç‚¹ï¼Œä½ ä»¬äº’å‘äº† **{rhythm['night_msg_count']}** æ¡æ¶ˆæ¯ã€‚å¦‚æœä¸æ¶‰åŠæ‹¯æ•‘åœ°çƒï¼Œé‚£ä¸€å®šæ¶‰åŠå¿ƒç¢æˆ–çƒ­æ‹ã€‚

---

## ğŸ­ Chapter 4: Communication Style (é£æ ¼)

> **lxg** å¹³å‡æ¯æ¡æ¶ˆæ¯ **{content['avg_len'].get('lxg', 0)}** ä¸ªå­—ï¼Œ**dxa** å¹³å‡æ¯æ¡ **{content['avg_len'].get('dxa', 0)}** ä¸ªå­—ã€‚
> ä¸€ä¸ªåœ¨å†™è¯—ï¼Œä¸€ä¸ªåœ¨å‘å®ï¼Ÿ

![Word Cloud](assets/viz_wordcloud.png)

*   **å“ˆå“ˆæŒ‡æ•°**: è¿™ä¸€å¹´ï¼Œä½ ä»¬è¯´äº† **{content['mood_counts']['haha']}** æ¬¡â€˜å“ˆå“ˆâ€™ã€‚å¦‚æœç¬‘å£°èƒ½å‘ç”µï¼Œä½ ä»¬èƒ½ä¾›äº®ä¸€åº§åŸƒè²å°”é“å¡”ã€‚
*   **æœ€é«˜è¿å‡»**: **dxa** æ›¾è¿ç»­å‘é€ **{content['streaks']['dxa']}** æ¡æ¶ˆæ¯ï¼Œ**lxg** æœ€é«˜è¿å‡» **{content['streaks']['lxg']}** æ¡ã€‚

![Habit Radar](assets/viz_radar.png)

---

## âš”ï¸ Chapter 5: Dynamics & Power (åšå¼ˆ)

> ä½ çš„å¹³å‡å›å¤æ—¶é—´æ˜¯ **{interaction['avg_reply_minutes'].get('dxa', 0)} åˆ†é’Ÿ**ï¼Œè€Œ TA æ˜¯ **{interaction['avg_reply_minutes'].get('lxg', 0)} åˆ†é’Ÿ**ã€‚è¿™æƒŠäººçš„æ—¶é—´å·®ï¼Œè—ç€è°çš„ä»å®¹å’Œè°çš„ç„¦ç¼ï¼Ÿ

![Speed Dist](assets/viz_speed_dist.png)

> åœ¨è¿™æ®µå…³ç³»é‡Œï¼Œ**{initiator_winner}** ä¸»åŠ¨å¼€å¯è¯é¢˜çš„æ¬¡æ•°å æ¯” **{initiator_ratio}%**ã€‚å»ºè®®ç»™ TA é¢å‘ä¸€ä¸ªâ€˜å¹´åº¦ç ´å†°å¤§ä½¿â€™å¥–ã€‚

---

## ğŸ’¾ Chapter 6: Digital Weight (é‡é‡)

> â€œæ•…äººä¾æ—§â€åœ¨ä½ ç”µè„‘ä¸­çš„åˆ†é‡ï¼Œå¤§æ¦‚æœ‰ **{weight['total_mb']} MB**ã€‚

*   ğŸ“¸ ç›¸å½“äº **{weight['equiv_photos']}** å¼ é«˜æ¸…ç…§ç‰‡
*   ğŸ¬ æˆ– **{weight['equiv_movies']}** éƒ¨é«˜æ¸…ç”µå½±
*   ğŸ¤ è¯­éŸ³æ¡æ•°: {summary['total_2025']} (Context: This might be inaccurate, total msgs used here, let's use file counts if available, but mining result used total mb estimation. Correct per Specs.)

---

## ğŸ·ï¸ The Wrap-up Card (æˆåˆ†è¡¨)

| å±æ€§ | dxa | lxg |
| :--- | :--- | :--- |
| **è¯ç—¨æŒ‡æ•° (Msg Count)** | {len([k for k in radar.get('dxa', {}).values()])} (éœ€ä¿®æ­£ä¸ºæ€»æ•°) | ... |
| **æœ€çˆ±è¡¨æƒ…åŒ…** | ![Sticker]({summary['top_sticker_url']}) (Top 1) | |

*(æ³¨ï¼šæ•°æ®å®Œå…¨åœ¨æœ¬åœ°è®¡ç®—ï¼Œä¿éšœéšç§å®‰å…¨)*

**Generated by Project MemoryLane**
"""
    
    # Write to file
    with open(OUTPUT_REPORT, "w", encoding="utf-8") as f:
        f.write(md)
        
    print(f"Report assembled: {OUTPUT_REPORT}")

if __name__ == "__main__":
    generate_markdown()
